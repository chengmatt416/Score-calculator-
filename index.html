<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoGebra Final Score Calculator (Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .gradient-bg { background: radial-gradient(circle at top right, #e0e7ff, #ffffff); }
    </style>
</head>
<body class="gradient-bg min-h-screen text-slate-800 p-4 lg:p-10">

    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <div class="bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden">
            <div class="bg-slate-900 p-6 text-white flex justify-between items-center">
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    Final Score 計算器
                </h1>
                <span class="text-xs bg-blue-600 px-2 py-1 rounded text-blue-100">v2.0 Precise</span>
            </div>

            <div class="p-8 space-y-6">
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Last Score</label>
                        <input type="number" id="inputLast" step="0.01" class="mono text-xl w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:ring-0 outline-none transition-colors placeholder-slate-300" placeholder="92.78">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Current Score</label>
                        <input type="number" id="inputCurrent" step="0.01" class="mono text-xl w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:ring-0 outline-none transition-colors placeholder-slate-300" placeholder="94.44">
                    </div>
                </div>

                <div class="bg-slate-50 rounded-2xl p-8 text-center border border-slate-200 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-blue-500/5 group-hover:bg-blue-500/10 transition-colors"></div>
                    <p class="text-slate-500 text-sm font-semibold uppercase tracking-widest relative z-10">Calculated Final Score</p>
                    <p id="singleResult" class="text-6xl font-black text-slate-800 mt-2 relative z-10 mono tracking-tight">-</p>
                </div>

                <div class="border-t border-slate-100 pt-6">
                    <button onclick="document.getElementById('debugPanel').classList.toggle('hidden')" class="text-xs text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1">
                        顯示/隱藏 計算細節 (Debug)
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    
                    <div id="debugPanel" class="hidden mt-4 bg-slate-900 rounded-lg p-4 text-xs font-mono text-green-400 overflow-x-auto">
                        <table class="w-full text-left">
                            <tr><td class="py-1 text-slate-400">Delta (Curr - Last):</td><td id="dbg_delta">-</td></tr>
                            <tr><td class="py-1 text-slate-400">ZP (Threshold):</td><td id="dbg_zp">-</td></tr>
                            <tr><td class="py-1 text-slate-400">Curve Used:</td><td id="dbg_curve">-</td></tr>
                            <tr><td colspan="2" class="border-t border-slate-700 my-2"></td></tr>
                            <tr><td class="py-1 text-slate-400">Coeff A (Quadratic):</td><td id="dbg_a">-</td></tr>
                            <tr><td class="py-1 text-slate-400">Coeff B (Linear):</td><td id="dbg_b">-</td></tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-white rounded-2xl shadow-xl border border-slate-100 p-8 h-full flex flex-col">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    </div>
                    <h2 class="text-xl font-bold text-slate-800">Excel 批次處理</h2>
                </div>

                <div class="flex-1 flex flex-col justify-center space-y-4">
                    <p class="text-sm text-slate-500">
                        支援 <code>.xlsx</code> 格式。系統會自動搜尋名稱包含 <code class="bg-slate-100 px-1 rounded">last</code> 與 <code class="bg-slate-100 px-1 rounded">current</code> 的欄位。
                    </p>

                    <div id="dropZone" class="flex-1 min-h-[200px] border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all group">
                        <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls">
                        <svg class="w-12 h-12 text-slate-300 group-hover:text-blue-500 mb-4 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <p class="text-slate-600 font-medium group-hover:text-blue-600">拖曳檔案 或 點擊上傳</p>
                    </div>

                    <div id="statusArea" class="hidden">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 flex items-center justify-between">
                            <span id="statusText" class="text-sm font-bold text-green-700">處理完成</span>
                            <button id="downloadBtn" class="bg-green-600 hover:bg-green-700 text-white text-sm px-4 py-2 rounded-lg shadow transition-transform active:scale-95">
                                下載結果
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 核心數學邏輯 (精確還原 GeoGebra)
        // ==========================================

        // 通用二次多項式: ax^2 + bx + c
        const poly = (x, a, b, c) => (a * x * x) + (b * x) + c;

        // 1. ZP (閾值計算) - 來自 Screenshot 6
        function getZP(last) {
            if (last < 75) {
                // 區間 [0, 75)
                return poly(last, 0.026666666667, -4.066666666667, 155);
            } else {
                // 區間 [75, 100]
                return poly(last, -0.005, 0.6, -16.875);
            }
        }

        // 2. 係數計算函式 (根據 Screenshot 2, 3, 4)
        // High Curve (Quadratic Term A) - Screenshot 3
        function getDrvt2H(last) {
            return poly(last, 0.0001317279461, -0.0066766329966, 0.0097777777778);
        }
        // Low Curve (Quadratic Term A) - Screenshot 3
        function getDrvt2L(last) {
            return poly(last, 0.0001041230769, -0.0090092307692, -0.16);
        }
        // High Curve (Linear Term B) - Screenshot 4
        function getDrvtVarH(last) {
            return poly(last, 0.0011776161616, -0.0581434343434, -1.5133333333333);
        }
        // Low Curve (Linear Term B) - Screenshot 2
        function getDrvtVarL(last) {
            return poly(last, 0.0029682051282, -0.5432820512821, 24.8);
        }

        // 3. 積分計算 (Integrate Ax + B => 0.5*A*x^2 + B*x)
        function integrate(val, A, B) {
            return (0.5 * A * val * val) + (B * val);
        }

        // 4. 主計算流程
        function calculateScore(last, current) {
            // 轉換為浮點數確保計算正確
            const l = parseFloat(last);
            const c = parseFloat(current);
            if (isNaN(l) || isNaN(c)) return null;

            // Step 1: 計算 Delta 與 ZP
            const delta = c - l;
            const zp = getZP(l);

            // Step 2: 決定使用哪條曲線 (High vs Low)
            // 根據 Screenshot 10: If(x <= zp(last), ...)
            let score = 0;
            let A = 0;
            let B = 0;
            let curveType = "";

            if (delta <= zp) {
                // 使用 Low Curve
                curveType = "Low (delta <= zp)";
                A = getDrvt2L(l);
                B = getDrvtVarL(l);
            } else {
                // 使用 High Curve
                curveType = "High (delta > zp)";
                A = getDrvt2H(l);
                B = getDrvtVarH(l);
            }

            // Step 3: 計算定積分差值 F(delta) - F(zp)
            const val_delta = integrate(delta, A, B);
            const val_zp = integrate(zp, A, B);
            score = val_delta - val_zp;

            return {
                score: score,
                debug: { delta, zp, curveType, A, B }
            };
        }

        // ==========================================
        // UI 互動邏輯
        // ==========================================
        const els = {
            last: document.getElementById('inputLast'),
            curr: document.getElementById('inputCurrent'),
            res: document.getElementById('singleResult'),
            // debug els
            d_delta: document.getElementById('dbg_delta'),
            d_zp: document.getElementById('dbg_zp'),
            d_curve: document.getElementById('dbg_curve'),
            d_a: document.getElementById('dbg_a'),
            d_b: document.getElementById('dbg_b')
        };

        function update() {
            const result = calculateScore(els.last.value, els.curr.value);
            
            if (result) {
                els.res.innerText = result.score.toFixed(4); // 顯示4位小數
                // 更新 Debug 資訊
                els.d_delta.innerText = result.debug.delta.toFixed(5);
                els.d_zp.innerText = result.debug.zp.toFixed(5);
                els.d_curve.innerText = result.debug.curveType;
                els.d_a.innerText = result.debug.A.toFixed(8);
                els.d_b.innerText = result.debug.B.toFixed(8);
            } else {
                els.res.innerText = "-";
            }
        }

        els.last.addEventListener('input', update);
        els.curr.addEventListener('input', update);

        // ==========================================
        // Excel 處理邏輯
        // ==========================================
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        let workbookBlob = null;

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500', 'bg-blue-50'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('border-blue-500', 'bg-blue-50'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            if(e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => { if(e.target.files.length) processFile(e.target.files[0]); });

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, {type: 'array'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(ws);

                    if (json.length === 0) throw new Error("Empty File");

                    const processed = json.map(row => {
                        // 模糊搜尋欄位 (忽略大小寫、空白)
                        const keys = Object.keys(row);
                        const lastKey = keys.find(k => k.toLowerCase().replace(/\s/g,'').includes('last'));
                        const currKey = keys.find(k => k.toLowerCase().replace(/\s/g,'').includes('current'));

                        if (lastKey && currKey) {
                            const res = calculateScore(row[lastKey], row[currKey]);
                            row['finalscore'] = res ? res.score : 'Error';
                        } else {
                            row['finalscore'] = 'Missing Columns';
                        }
                        return row;
                    });

                    const newWs = XLSX.utils.json_to_sheet(processed);
                    const newWb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(newWb, newWs, "Results");
                    workbookBlob = newWb;

                    document.getElementById('statusArea').classList.remove('hidden');
                    document.getElementById('statusText').innerText = `成功計算 ${processed.length} 筆資料`;
                } catch (err) {
                    alert("讀取錯誤：請確認 Excel 格式正確");
                    console.error(err);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        document.getElementById('downloadBtn').addEventListener('click', () => {
            if(workbookBlob) XLSX.writeFile(workbookBlob, "FinalScore_Result.xlsx");
        });

    </script>
</body>
</html>
